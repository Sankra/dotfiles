#!/usr/bin/env bash
set -e

echo "Configuring your new Mac"

echo "Enabling sudo"
sudo -v

echo "All access all the time"
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

echo "Copying bash profile..."

cp ./.bash-profile ~/.bash-profile -f

echo "Security & Privacy"

echo "Enabling FileVault"
fdesetup enable

echo "Enabling firewall"
defaults write /Library/Preferences/com.apple.alf globalstate -int 1

launchctl unload /System/Library/LaunchAgents/com.apple.alf.useragent.plist
launchctl unload /System/Library/LaunchDaemons/com.apple.alf.agent.plist

launchctl load /System/Library/LaunchDaemons/com.apple.alf.agent.plist
launchctl load /System/Library/LaunchAgents/com.apple.alf.useragent.plist

echo "No password delay"
defaults write com.apple.screensaver askForPasswordDelay -int 0

echo "Installing XCode commandline tools"
xcode-select --install

echo "Installing Homebrew"
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

echo "Installing brews listed in brews.txt"
sh install_brews

echo "Installing casks listed in casks.txt"
sh install_casks

echo "Installing apps listed in apps.txt"
sh install_apps

echo "Adjusting Dock"

# Minimize windows into their applicationâ€™s icon
defaults write com.apple.dock minimize-to-application -bool true

# Show indicator lights for open applications in the Dock
defaults write com.apple.dock show-process-indicators -bool false

# Position (left, bottom, right)
defaults write com.apple.dock orientation -string "left"

# Disable double-click a window's title bar to minimize
defaults write NSGlobalDomain AppleMiniaturizeOnDoubleClick -bool false

echo "Dark mode"
defaults write /Library/Preferences/.GlobalPreferences AppleInterfaceTheme Dark

echo "Adjusting Finder"

# When performing a search, search the current folder by default
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

# no warning prompt when changing file extension
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false 

# New window points to projects
defaults write com.apple.finder NewWindowTarget -string "PfLo" "file://~/projects"

# Show icons for servers on the desktop
defaults write com.apple.finder ShowMountedServersOnDesktop -bool true

# Disable the warning before emptying the Trash
defaults write com.apple.finder WarnOnEmptyTrash -bool false

killall Dock
killall SystemUIServer
killall Finder